<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ROTC Accountability</title>
  <style>
    body { font-family: Arial; margin: 20px; }
    .cadet { margin-bottom: 14px; }
    button { margin-right: 6px; }
    button.active {
      background: #222;
      color: white;
      font-weight: bold;
    }
    input[disabled] {
      background: #eee;
    }
  </style>
</head>
<body>

<h1>ROTC Accountability</h1>

<label>Session:</label>
<select id="sessionType">
  <option value="PT">PT</option>
  <option value="LAB">LAB</option>
</select>

<br><br>

<label>Platoon:</label>
<select id="platoonSelect"></select>

<hr>

<div id="roster"></div>

<br>

<button onclick="startSession()">Start Session (TEMP)</button>
<button onclick="submitAttendance()">Submit Accountability</button>

<pre id="output"></pre>

<script src="roster.js"></script>
<script src="app.js"></script>

<script>
const state = { entries: {} };

// ================= START SESSION =================
async function startSession() {
  const sessionType = document.getElementById("sessionType").value;
  const platoon = document.getElementById("platoonSelect").value;

  const res = await fetch(SCRIPT_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      action: "START_SESSION",
      key: "starter-pt-93KfQ2", // must match backend
      sessionType,
      platoon,
      startedBy: "Tester"
    })
  });

  const data = await res.json();
  document.getElementById("output").textContent =
    JSON.stringify(data, null, 2);
}

// ================= LOAD PLATOONS =================
function loadPlatoons() {
  const sel = document.getElementById("platoonSelect");
  sel.innerHTML = "";

  Object.keys(PLATOONS).forEach(p => {
    const opt = document.createElement("option");
    opt.value = p;
    opt.textContent = p;
    sel.appendChild(opt);
  });

  sel.onchange = loadRoster;
  loadRoster();
}

// ================= LOAD ROSTER =================
function loadRoster() {
  const platoon = document.getElementById("platoonSelect").value;
  const rosterDiv = document.getElementById("roster");
  rosterDiv.innerHTML = "";

  // preserve existing state if already loaded
  if (!state.entries) state.entries = {};
  if (!state.entries[platoon]) {
    state.entries[platoon] = {};
    PLATOONS[platoon].forEach(name => {
      state.entries[platoon][name] = { status: "", reason: "" };
    });
  }

  PLATOONS[platoon].forEach(name => {
    const entry = state.entries[platoon][name];

    const div = document.createElement("div");
    div.className = "cadet";

    div.innerHTML = `
      <b>${name}</b><br>
      <button class="${entry.status === 'PRESENT' ? 'active' : ''}"
              onclick="setStatus('${name}','PRESENT')">Present</button>

      <button class="${entry.status === 'EXCUSED' ? 'active' : ''}"
              onclick="setStatus('${name}','EXCUSED')">Excused</button>

      <button class="${entry.status === 'ABSENT' ? 'active' : ''}"
              onclick="setStatus('${name}','ABSENT')">Absent</button>

      <br>
      <input placeholder="Reason (required if excused)"
             value="${entry.reason}"
             ${entry.status !== 'EXCUSED' ? 'disabled' : ''}
             oninput="state.entries['${platoon}']['${name}'].reason=this.value">
    `;

    rosterDiv.appendChild(div);
  });
}

// ================= SET STATUS =================
function setStatus(name, status) {
  const platoon = document.getElementById("platoonSelect").value;
  state.entries[platoon][name].status = status;

  // Clear reason if not excused
  if (status !== "EXCUSED") {
    state.entries[platoon][name].reason = "";
  }

  loadRoster(); // re-render UI to reflect change
}

// ================= SUBMIT =================
async function submitAttendance() {
  const sessionType = document.getElementById("sessionType").value;
  const platoon = document.getElementById("platoonSelect").value;

  const entries = Object.entries(state.entries[platoon]).map(([name, data]) => ({
    name,
    status: data.status,
    reason: data.reason
  }));

  for (const e of entries) {
    if (!e.status) {
      alert("Missing status for someone");
      return;
    }
    if (e.status === "EXCUSED" && !e.reason) {
      alert("Excused requires a reason");
      return;
    }
  }

  const res = await fetch(SCRIPT_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      action: "SUBMIT_ATTENDANCE",
      sessionType,
      platoon,
      entries
    })
  });

  const data = await res.json();
  document.getElementById("output").textContent =
    JSON.stringify(data, null, 2);
}

// ================= INIT =================
loadPlatoons();
</script>

</body>
</html>

