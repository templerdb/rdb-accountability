<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ROTC Accountability</title>
  <style>
    body { font-family: Arial; margin: 20px; }
    .cadet { margin-bottom: 10px; }
    button.active { font-weight: bold; }
  </style>
</head>
<body>

<h1>ROTC Accountability</h1>

<label>Session:</label>
<select id="sessionType">
  <option value="PT">PT</option>
  <option value="LAB">LAB</option>
</select>

<br><br>

<label>Platoon:</label>
<select id="platoonSelect"></select>

<div id="roster"></div>

<br>
<button onclick="startSession()">Start Session (TEMP)</button>
  
<br>
<button onclick="submitAttendance()">Submit Accountability</button>

<pre id="output"></pre>

<script src="roster.js"></script>
<script src="app.js"></script>
<script>
const state = {};

async function startSession() {
  const sessionType = document.getElementById("sessionType").value;
  const platoon = document.getElementById("platoonSelect").value;

  const res = await fetch(SCRIPT_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      action: "START_SESSION",
      key: "starter-pt-93KfQ2", // SAME key as backend
      sessionType,
      platoon,
      startedBy: "Tester"
    })
  });

  const data = await res.json();
  document.getElementById("output").textContent =
    JSON.stringify(data, null, 2);
}


function loadPlatoons() {
  const sel = document.getElementById("platoonSelect");
  Object.keys(PLATOONS).forEach(p => {
    const opt = document.createElement("option");
    opt.value = p;
    opt.textContent = p;
    sel.appendChild(opt);
  });
  sel.onchange = loadRoster;
  loadRoster();
}

function loadRoster() {
  const platoon = platoonSelect.value;
  const rosterDiv = document.getElementById("roster");
  rosterDiv.innerHTML = "";
  state.entries = {};

  PLATOONS[platoon].forEach(name => {
    state.entries[name] = { status: "", reason: "" };

    const div = document.createElement("div");
    div.className = "cadet";

    div.innerHTML = `
      <b>${name}</b><br>
      <button onclick="setStatus('${name}','PRESENT')">Present</button>
      <button onclick="setStatus('${name}','EXCUSED')">Excused</button>
      <button onclick="setStatus('${name}','ABSENT')">Absent</button>
      <input placeholder="Reason (if excused)"
             oninput="state.entries['${name}'].reason=this.value">
    `;
    rosterDiv.appendChild(div);
  });
}

function setStatus(name, status) {
  state.entries[name].status = status;
}

async function submitAttendance() {
  const sessionType = document.getElementById("sessionType").value;
  const platoon = document.getElementById("platoonSelect").value;

  const entries = Object.entries(state.entries).map(([name, data]) => ({
    name,
    status: data.status,
    reason: data.reason
  }));

  for (const e of entries) {
    if (!e.status) {
      alert("Missing status for someone");
      return;
    }
    if (e.status === "EXCUSED" && !e.reason) {
      alert("Excused needs reason");
      return;
    }
  }

  const res = await fetch(SCRIPT_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      action: "SUBMIT_ATTENDANCE",
      sessionType,
      platoon,
      entries
    })
  });

  const data = await res.json();
  document.getElementById("output").textContent =
    JSON.stringify(data, null, 2);
}

loadPlatoons();
</script>
</body>
</html>

